local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local authorizedPlayers = {"solid_chicken4391", "afkusergag", "TadHub_official"} 
local localPlayer = Players.LocalPlayer

local frozenPlayers = {}
local spinningPlayers = {}

-- ตรวจสอบว่าผู้เล่นได้รับอนุญาต
local function isAuthorized(name)
    for _, authName in ipairs(authorizedPlayers) do
        if name:lower() == authName:lower() then
            return true
        end
    end
    return false
end

-- หาผู้เล่นที่ใกล้เคียงที่สุด
local function getClosestPlayerByName(name)
    name = name:lower()
    local closestPlayer = nil
    local shortestDistance = math.huge
    for _, player in pairs(Players:GetPlayers()) do
        local playerName = player.Name:lower()
        if playerName:find(name) then
            local distance = math.abs(#playerName - #name)
            if distance < shortestDistance then
                shortestDistance = distance
                closestPlayer = player
            end
        end
    end
    return closestPlayer
end

-- ตรวจว่าชื่อเป้าหมายคือเราไหม
local function isTargetLocalPlayer(targetName)
    targetName = targetName:lower()
    local localName = localPlayer.Name:lower()
    return string.find(localName, targetName) or string.find(targetName, localName)
end

-- Freeze / Unfreeze
local function freezePlayer(player)
    local character = player.Character
    if character then
        local humanoidRoot = character:FindFirstChild("HumanoidRootPart")
        if humanoidRoot then
            frozenPlayers[player] = humanoidRoot.Anchored
            humanoidRoot.Anchored = true
        end
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.WalkSpeed = 0
            humanoid.JumpPower = 0
        end
    end
end

local function unfreezePlayer(player)
    local character = player.Character
    if character then
        local humanoidRoot = character:FindFirstChild("HumanoidRootPart")
        if humanoidRoot and frozenPlayers[player] ~= nil then
            humanoidRoot.Anchored = frozenPlayers[player]
            frozenPlayers[player] = nil
        end
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.WalkSpeed = 16
            humanoid.JumpPower = 50
        end
    end
end

-- Bring / TP
local function bringPlayer(targetPlayer, callerPlayer)
    local targetChar = targetPlayer.Character
    local callerChar = callerPlayer.Character
    if targetChar and callerChar then
        local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
        local callerHRP = callerChar:FindFirstChild("HumanoidRootPart")
        if targetHRP and callerHRP then
            targetHRP.CFrame = callerHRP.CFrame * CFrame.new(0, 0, 3)
            local humanoid = targetChar:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.PlatformStand = true
                task.wait(0.1)
                humanoid.PlatformStand = false
            end
        end
    end
end

local function tpToPlayer(targetPlayer)
    local myCharacter = localPlayer.Character
    local targetCharacter = targetPlayer.Character
    if myCharacter and targetCharacter then
        local myHrp = myCharacter:FindFirstChild("HumanoidRootPart")
        local targetHrp = targetCharacter:FindFirstChild("HumanoidRootPart")
        if myHrp and targetHrp then
            myHrp.CFrame = targetHrp.CFrame * CFrame.new(0, 0, 3)
        end
    end
end

-- Give / Speed
local function giveItem(targetPlayer, itemName)
    print("แจกไอเทม " .. itemName .. " ให้ " .. targetPlayer.Name)
end

local function setSpeed(targetPlayer, speedValue)
    local character = targetPlayer.Character
    if character then
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.WalkSpeed = tonumber(speedValue) or 16
        end
    end
end

-- Spin
local function startSpin(player, speed)
    speed = tonumber(speed) or 50
    if spinningPlayers[player] then
        spinningPlayers[player]:Disconnect()
        spinningPlayers[player] = nil
    end
    local character = player.Character
    if not character then return end
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local conn
    conn = RunService.Heartbeat:Connect(function(deltaTime)
        hrp.CFrame = hrp.CFrame * CFrame.Angles(0, math.rad(speed * deltaTime), 0)
        if not spinningPlayers[player] then
            conn:Disconnect()
        end
    end)
    spinningPlayers[player] = conn
end

local function stopSpin(player)
    if spinningPlayers[player] then
        spinningPlayers[player]:Disconnect()
        spinningPlayers[player] = nil
    end
end

-- Explode
local function explodePlayer(targetPlayer)
    local character = targetPlayer.Character
    if character then
        local hrp = character:FindFirstChild("HumanoidRootPart")
        if hrp then
            local explosion = Instance.new("Explosion")
            explosion.Position = hrp.Position
            explosion.BlastRadius = 10
            explosion.BlastPressure = 500000
            explosion.Parent = workspace
            local humanoid = character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.Health = 0
            end
        end
    end
end

-- Fling
local function flingPlayer(targetPlayer)
    local character = targetPlayer.Character
    if character then
        local hrp = character:FindFirstChild("HumanoidRootPart")
        if hrp then
            local randomDirection = Vector3.new(
                math.random(-1, 1),
                math.random(1, 2),
                math.random(-1, 1)
            ).Unit
            hrp.Velocity = randomDirection * math.random(200, 300)
        end
    end
end

-- Handle Commands
local function onPlayerChatted(player, message)
    local msg = message:lower()
    if not isAuthorized(player.Name) then return end

    local split = msg:split(" ")
    local command = split[1]
    local targetName = split[2]
    local extra = split[3]

    if command == "/kill" and targetName then
        if isTargetLocalPlayer(targetName) then
            local humanoid = localPlayer.Character and localPlayer.Character:FindFirstChildOfClass("Humanoid")
            if humanoid then humanoid.Health = 0 end
        else
            local targetPlayer = getClosestPlayerByName(targetName)
            if targetPlayer then
                local humanoid = targetPlayer.Character and targetPlayer.Character:FindFirstChildOfClass("Humanoid")
                if humanoid then humanoid.Health = 0 end
            end
        end
    elseif command == "/heal" and targetName then
        local targetPlayer = getClosestPlayerByName(targetName)
        if targetPlayer then
            local humanoid = targetPlayer.Character and targetPlayer.Character:FindFirstChildOfClass("Humanoid")
            if humanoid then humanoid.Health = humanoid.MaxHealth end
        end
    elseif command == "/bring" and targetName then
        local targetPlayer = getClosestPlayerByName(targetName)
        if targetPlayer then bringPlayer(targetPlayer, player) end
    elseif command == "/tp" and targetName then
        local targetPlayer = getClosestPlayerByName(targetName)
        if targetPlayer then tpToPlayer(targetPlayer) end
    elseif command == "/freeze" and targetName then
        local targetPlayer = getClosestPlayerByName(targetName)
        if targetPlayer then freezePlayer(targetPlayer) end
    elseif command == "/unfreeze" and targetName then
        local targetPlayer = getClosestPlayerByName(targetName)
        if targetPlayer then unfreezePlayer(targetPlayer) end
    elseif command == "/give" and targetName and extra then
        local targetPlayer = getClosestPlayerByName(targetName)
        if targetPlayer then giveItem(targetPlayer, extra) end
    elseif command == "/speed" and targetName and extra then
        local targetPlayer = getClosestPlayerByName(targetName)
        if targetPlayer then setSpeed(targetPlayer, extra) end
    elseif command == "/spin" and targetName and extra then
        local targetPlayer = getClosestPlayerByName(targetName)
        if targetPlayer then startSpin(targetPlayer, extra) end
    elseif command == "/spinstop" and targetName then
        local targetPlayer = getClosestPlayerByName(targetName)
        if targetPlayer then stopSpin(targetPlayer) end
    elseif command == "/explode" and targetName then
        local targetPlayer = getClosestPlayerByName(targetName)
        if targetPlayer then explodePlayer(targetPlayer) end
    elseif command == "/fling" and targetName then
        local targetPlayer = getClosestPlayerByName(targetName)
        if targetPlayer then flingPlayer(targetPlayer) end
    elseif command == "/explodeall" then
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= player then explodePlayer(p) end
        end
    elseif command == "/flingall" then
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= player then flingPlayer(p) end
        end
    end
end

-- Connect chat
local function connectToChat(player)
    player.Chatted:Connect(function(message)
        onPlayerChatted(player, message)
    end)
end

for _, player in pairs(Players:GetPlayers()) do
    connectToChat(player)
end
Players.PlayerAdded:Connect(connectToChat)
