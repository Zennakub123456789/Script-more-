--// Pretty Player List GUI (Mobile-friendly, Draggable, Search, Copy Username/UserId)
--// Features:
--// - Floating toggle button to show/hide
--// - Draggable title bar & floating button
--// - Search filter by DisplayName/Username
--// - Copy Username / UserId (setclipboard), fallback toast
--// - Auto refresh every 1s
--// - Rounded corners, soft shadow, UIStroke
--// - Lives in CoreGui to persist through character resets

if getgenv and getgenv().PrettyListGUI_Running then return end
if getgenv then getgenv().PrettyListGUI_Running = true end

local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local LP = Players.LocalPlayer

local function safeParent()
    local cg = (game:GetService("CoreGui") or LP:FindFirstChildOfClass("PlayerGui"))
    return cg or LP:WaitForChild("PlayerGui")
end

local function notify(title, text)
    pcall(function()
        StarterGui:SetCore("SendNotification", {
            Title = title,
            Text = text,
            Duration = 3
        })
    end)
end

local function set_clipboard(str)
    local ok = false
    ok = pcall(function()
        if setclipboard then setclipboard(str) else error("no setclipboard") end
    end)
    if ok then
        notify("Copied", str)
    else
        notify("Copy failed", "Executor does not allow setclipboard.")
    end
end

-- Clean up older instance
pcall(function()
    local old = safeParent():FindFirstChild("PrettyListUI")
    if old then old:Destroy() end
end)

-- UI Create helpers
local function corner(obj, r)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, r or 12)
    c.Parent = obj
    return c
end

local function stroke(obj, t, col)
    local s = Instance.new("UIStroke")
    s.Thickness = t or 1.5
    s.Color = col or Color3.fromRGB(30,30,30)
    s.Transparency = 0.25
    s.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    s.Parent = obj
    return s
end

local function shadow(parent)
    local sh = Instance.new("ImageLabel")
    sh.Name = "Shadow"
    sh.BackgroundTransparency = 1
    sh.Image = "rbxassetid://5028857084"
    sh.ImageColor3 = Color3.fromRGB(0,0,0)
    sh.ImageTransparency = 0.6
    sh.ScaleType = Enum.ScaleType.Slice
    sh.SliceCenter = Rect.new(24,24,276,276)
    sh.Size = UDim2.new(1, 20, 1, 20)
    sh.Position = UDim2.new(0, -10, 0, -10)
    sh.ZIndex = 0
    sh.Parent = parent
end

-- Main ScreenGui
local sg = Instance.new("ScreenGui")
sg.Name = "PrettyListUI"
sg.ResetOnSpawn = false
sg.IgnoreGuiInset = false
sg.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
sg.Parent = safeParent()

-- Saved positions using getgenv
getgenv().PrettyList_Pos = getgenv().PrettyList_Pos or UDim2.fromOffset(80, 120)
getgenv().PrettyList_Toggle_Pos = getgenv().PrettyList_Toggle_Pos or UDim2.fromOffset(24, 200)

-- Floating Toggle Button
local floatBtn = Instance.new("Frame")
floatBtn.Name = "FloatToggle"
floatBtn.Size = UDim2.fromOffset(46, 46)
floatBtn.Position = getgenv().PrettyList_Toggle_Pos
floatBtn.BackgroundColor3 = Color3.fromRGB(255,255,255)
floatBtn.BackgroundTransparency = 0.1
floatBtn.Active = true
floatBtn.Draggable = true
floatBtn.Parent = sg
corner(floatBtn, 16)
stroke(floatBtn, 1.5, Color3.fromRGB(0,0,0))
shadow(floatBtn)

local icon = Instance.new("TextLabel")
icon.Size = UDim2.fromScale(1,1)
icon.BackgroundTransparency = 1
icon.Text = "≡"
icon.Font = Enum.Font.GothamBold
icon.TextScaled = true
icon.TextColor3 = Color3.fromRGB(30,30,30)
icon.Parent = floatBtn

-- Main Window
local win = Instance.new("Frame")
win.Name = "Window"
win.Size = UDim2.fromOffset(420, 460)
win.Position = getgenv().PrettyList_Pos
win.Visible = false
win.BackgroundColor3 = Color3.fromRGB(245,245,245)
win.Active = true
win.Draggable = true
win.Parent = sg
corner(win, 18)
stroke(win, 1.6, Color3.fromRGB(0,0,0))
shadow(win)

-- Title Bar (draggable)
local titleBar = Instance.new("Frame")
titleBar.Name = "TitleBar"
titleBar.Size = UDim2.new(1, 0, 0, 44)
titleBar.BackgroundColor3 = Color3.fromRGB(255,255,255)
titleBar.Active = true
titleBar.Parent = win
corner(titleBar, 18)
stroke(titleBar, 1, Color3.fromRGB(220,220,220))

local title = Instance.new("TextLabel")
title.BackgroundTransparency = 1
title.Position = UDim2.fromOffset(16, 0)
title.Size = UDim2.new(1, -140, 1, 0)
title.Font = Enum.Font.GothamSemibold
title.TextSize = 18
title.TextXAlignment = Enum.TextXAlignment.Left
title.Text = "Player List"
title.TextColor3 = Color3.fromRGB(35,35,35)
title.Parent = titleBar

local statusLbl = Instance.new("TextLabel")
statusLbl.BackgroundTransparency = 1
statusLbl.AnchorPoint = Vector2.new(1,0)
statusLbl.Position = UDim2.new(1, -56, 0, 0)
statusLbl.Size = UDim2.fromOffset(120, 44)
statusLbl.Font = Enum.Font.Gotham
statusLbl.TextSize = 14
statusLbl.TextXAlignment = Enum.TextXAlignment.Right
statusLbl.TextColor3 = Color3.fromRGB(90,90,90)
statusLbl.Text = "Hidden"
statusLbl.Parent = titleBar

local closeBtn = Instance.new("TextButton")
closeBtn.BackgroundTransparency = 1
closeBtn.AnchorPoint = Vector2.new(1,0)
closeBtn.Position = UDim2.new(1, -12, 0, 0)
closeBtn.Size = UDim2.fromOffset(36, 44)
closeBtn.Font = Enum.Font.GothamBold
closeBtn.Text = "×"
closeBtn.TextSize = 24
closeBtn.TextColor3 = Color3.fromRGB(120,30,30)
closeBtn.Parent = titleBar

-- Search + Sort
local topBar = Instance.new("Frame")
topBar.Name = "TopBar"
topBar.Size = UDim2.new(1, -24, 0, 42)
topBar.Position = UDim2.fromOffset(12, 56)
topBar.BackgroundColor3 = Color3.fromRGB(255,255,255)
topBar.Parent = win
corner(topBar, 12)
stroke(topBar, 1, Color3.fromRGB(225,225,225))

local search = Instance.new("TextBox")
search.PlaceholderText = "Search by display/username..."
search.Text = ""
search.ClearTextOnFocus = false
search.Font = Enum.Font.Gotham
search.TextSize = 14
search.TextXAlignment = Enum.TextXAlignment.Left
search.TextColor3 = Color3.fromRGB(45,45,45)
search.PlaceholderColor3 = Color3.fromRGB(150,150,150)
search.BackgroundTransparency = 1
search.Position = UDim2.fromOffset(12, 0)
search.Size = UDim2.new(1, -160, 1, 0)
search.Parent = topBar

local sortAZ = Instance.new("TextButton")
sortAZ.Text = "A→Z"
sortAZ.Font = Enum.Font.GothamSemibold
sortAZ.TextSize = 14
sortAZ.BackgroundColor3 = Color3.fromRGB(245,245,245)
sortAZ.Size = UDim2.fromOffset(60, 30)
sortAZ.Position = UDim2.new(1, -136, 0.5, -15)
sortAZ.Parent = topBar
corner(sortAZ, 10)
stroke(sortAZ, 1, Color3.fromRGB(230,230,230))

local sortZA = sortAZ:Clone()
sortZA.Text = "Z→A"
sortZA.Position = UDim2.new(1, -68, 0.5, -15)
sortZA.Parent = topBar

-- List container
local listHolder = Instance.new("Frame")
listHolder.Name = "ListHolder"
listHolder.Size = UDim2.new(1, -24, 1, -56-42-16)
listHolder.Position = UDim2.new(0, 12, 0, 56+42+8)
listHolder.BackgroundTransparency = 1
listHolder.Parent = win

local scroll = Instance.new("ScrollingFrame")
scroll.Size = UDim2.fromScale(1,1)
scroll.CanvasSize = UDim2.new(0,0,0,0)
scroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
scroll.BackgroundTransparency = 1
scroll.ScrollBarThickness = 6
scroll.ScrollingDirection = Enum.ScrollingDirection.Y
scroll.Parent = listHolder

local layout = Instance.new("UIListLayout")
layout.Padding = UDim.new(0, 8)
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Parent = scroll

local pad = Instance.new("UIPadding")
pad.PaddingTop = UDim.new(0, 4)
pad.PaddingBottom = UDim.new(0, 8)
pad.PaddingLeft = UDim.new(0, 2)
pad.PaddingRight = UDim.new(0, 2)
pad.Parent = scroll

-- Row builder
local thumbType = Enum.ThumbnailType.HeadShot
local thumbSize = Enum.ThumbnailSize.Size100x100

-- แก้ในฟังก์ชัน makeRow(plr) ให้เป็นแบบนี้
local function makeRow(plr)
    local row = Instance.new("Frame")
    row.Name = "Row_"..plr.UserId
    row.Size = UDim2.new(1, -6, 0, 64)
    row.BackgroundColor3 = Color3.fromRGB(255,255,255)
    row.Parent = scroll
    corner(row, 12)
    stroke(row, 1, Color3.fromRGB(230,230,230))

    local thumb = Instance.new("ImageLabel")
    thumb.BackgroundTransparency = 1
    thumb.Size = UDim2.fromOffset(48,48)
    thumb.Position = UDim2.fromOffset(12, 8)
    thumb.Parent = row
    pcall(function()
        local url = Players:GetUserThumbnailAsync(plr.UserId, thumbType, thumbSize)
        thumb.Image = url
    end)

    local nameLbl = Instance.new("TextLabel")
    nameLbl.BackgroundTransparency = 1
    nameLbl.Position = UDim2.fromOffset(68, 8)
    nameLbl.Size = UDim2.new(1, -240, 0, 24)
    nameLbl.Font = Enum.Font.GothamSemibold
    nameLbl.TextSize = 16
    nameLbl.TextXAlignment = Enum.TextXAlignment.Left
    nameLbl.TextColor3 = Color3.fromRGB(35,35,35)
    nameLbl.Text = string.format("%s  @%s", plr.DisplayName or plr.Name, plr.Name)
    nameLbl.Parent = row

    local idLbl = Instance.new("TextLabel")
    idLbl.BackgroundTransparency = 1
    idLbl.Position = UDim2.fromOffset(68, 34)
    idLbl.Size = UDim2.new(1, -240, 0, 20)
    idLbl.Font = Enum.Font.Gotham
    idLbl.TextSize = 13
    idLbl.TextXAlignment = Enum.TextXAlignment.Left
    idLbl.TextColor3 = Color3.fromRGB(95,95,95)
    idLbl.Text = "UserId: "..tostring(plr.UserId)
    idLbl.Parent = row

    -- ปรับขนาดปุ่มให้เล็กลง และย้ายลงมา
    local copyUser = Instance.new("TextButton")
    copyUser.Text = "Copy Username"
    copyUser.Font = Enum.Font.Gotham
    copyUser.TextSize = 12
    copyUser.Size = UDim2.fromOffset(90, 24) -- ลดขนาด
    copyUser.Position = UDim2.new(1, -200, 0, -20) -- ย้ายลง
    copyUser.BackgroundColor3 = Color3.fromRGB(242,242,242)
    copyUser.Parent = row
    corner(copyUser, 8)
    stroke(copyUser, 1, Color3.fromRGB(230,230,230))

    local copyId = copyUser:Clone()
    copyId.Text = "Copy UserId"
    copyId.Position = UDim2.new(1, -100, 0, -20) -- ย้ายลงเหมือนกัน
    copyId.Parent = row

    copyUser.MouseButton1Click:Connect(function()
        set_clipboard(plr.Name)
    end)
    copyId.MouseButton1Click:Connect(function()
        set_clipboard(tostring(plr.UserId))
    end)

    return row
end

-- Data + render
local sortMode = "AZ"
local filterText = ""

local function getFilteredSortedPlayers()
    local list = {}
    for _,p in ipairs(Players:GetPlayers()) do
        if p and p.Parent then
            local dn = (p.DisplayName or p.Name):lower()
            local un = p.Name:lower()
            local f = filterText:lower()
            if f == "" or dn:find(f,1,true) or un:find(f,1,true) then
                table.insert(list, p)
            end
        end
    end
    table.sort(list, function(a,b)
        local A = (a.DisplayName or a.Name):lower()
        local B = (b.DisplayName or b.Name):lower()
        if sortMode == "AZ" then
            return A < B
        else
            return A > B
        end
    end)
    return list
end

local function clearRows()
    for _,c in ipairs(scroll:GetChildren()) do
        if c:IsA("Frame") and c.Name:match("^Row_") then
            c:Destroy()
        end
    end
end

local function render()
    clearRows()
    local arr = getFilteredSortedPlayers()
    for _,p in ipairs(arr) do
        makeRow(p)
    end
end

-- Toggle show/hide behavior
local function setVisible(v)
    win.Visible = v
    statusLbl.Text = v and "Visible" or "Hidden"
    TweenService:Create(win, TweenInfo.new(0.15, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
        BackgroundTransparency = v and 0.1 or 0.25
    }):Play()
end

floatBtn.InputBegan:Connect(function(io)
    if io.UserInputType == Enum.UserInputType.MouseButton1 or io.UserInputType == Enum.UserInputType.Touch then
        local start = tick()
        local conn; conn = floatBtn.InputEnded:Connect(function(ie)
            conn:Disconnect()
            if ie.UserInputType == io.UserInputType then
                if tick() - start < 0.2 then
                    setVisible(not win.Visible)
                    if win.Visible then
                        render() -- รีเฟรชทันทีหลังเปิด
                    end
                end
            end
        end)
    end
end)

closeBtn.MouseButton1Click:Connect(function()
    setVisible(false)
end)

-- Save positions on move
local function trackDrag(frame, storeKey)
    frame:GetPropertyChangedSignal("Position"):Connect(function()
        if storeKey == "win" then
            getgenv().PrettyList_Pos = frame.Position
        else
            getgenv().PrettyList_Toggle_Pos = frame.Position
        end
    end)
end
trackDrag(win, "win")
trackDrag(floatBtn, "btn")

-- Make window follow titlebar drag
titleBar:GetPropertyChangedSignal("AbsolutePosition"):Connect(function()
    -- Ensure main frame moves with title drag (Roblox handles Draggable, but we also save)
    getgenv().PrettyList_Pos = win.Position
end)

-- Controls
search:GetPropertyChangedSignal("Text"):Connect(function()
    filterText = search.Text or ""
    render()
end)
sortAZ.MouseButton1Click:Connect(function()
    sortMode = "AZ"
    render()
end)
sortZA.MouseButton1Click:Connect(function()
    sortMode = "ZA"
    render()
end)

-- React to player join/leave
Players.PlayerAdded:Connect(function()
    render()
end)
Players.PlayerRemoving:Connect(function()
    render()
end)

-- Initial
setVisible(false)
render()
