pcall(function()
    if getgenv()._FULL_LOADER and getgenv()._FULL_LOADER.Destroy then
        getgenv()._FULL_LOADER:Destroy()
    end
end)

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ContentProvider = game:GetService("ContentProvider")
local Lighting = game:GetService("Lighting")
local CoreGui = game:GetService("CoreGui")

local lp = Players.LocalPlayer

local function getSafeParent()
    local parent = CoreGui
    local ok, gethui = pcall(function() return gethui end)
    if ok and type(gethui) == "function" then
        local gui = gethui()
        if typeof(gui) == "Instance" then parent = gui end
    end
    return parent
end

local function protectGui(gui)
    pcall(function() if syn and syn.protect_gui then syn.protect_gui(gui) end end)
    pcall(function() if get_hidden_gui then get_hidden_gui(gui) end end)
end

local gui = Instance.new("ScreenGui")
gui.Name = "_FULL_LOADER"
gui.IgnoreGuiInset = true
gui.ResetOnSpawn = false
gui.DisplayOrder = 1_000_000
gui.ZIndexBehavior = Enum.ZIndexBehavior.Global
gui.Parent = getSafeParent()
protectGui(gui)
getgenv()._FULL_LOADER = gui

local blur = Instance.new("BlurEffect")
blur.Name = "_LoaderBlur"
blur.Size = 0
blur.Parent = Lighting
TweenService:Create(blur, TweenInfo.new(0.35, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), { Size = 28 }):Play()

local bg = Instance.new("Frame")
bg.Name = "BG"
bg.Size = UDim2.fromScale(1, 1)
bg.BackgroundColor3 = Color3.fromRGB(18, 18, 20)
bg.BackgroundTransparency = 0
bg.Parent = gui

local grad = Instance.new("UIGradient")
grad.Rotation = 0
grad.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0.00, Color3.fromRGB(30, 30, 35)),
    ColorSequenceKeypoint.new(0.50, Color3.fromRGB(45, 50, 65)),
    ColorSequenceKeypoint.new(1.00, Color3.fromRGB(25, 25, 35))
})
grad.Offset = Vector2.new(0, 0)
grad.Parent = bg

local vignette = Instance.new("ImageLabel")
vignette.Name = "Vignette"
vignette.BackgroundTransparency = 1
vignette.Image = "rbxassetid://4991431217" -- soft vignette texture; safe fallback
vignette.ScaleType = Enum.ScaleType.Slice
vignette.SliceCenter = Rect.new(256,256,256,256)
vignette.ImageTransparency = 0.55
vignette.Size = UDim2.fromScale(1.2, 1.2)
vignette.Position = UDim2.fromScale(-0.1, -0.1)
vignette.Parent = bg

local particleFolder = Instance.new("Folder", bg)
particleFolder.Name = "Particles"

local function spawnParticle()
    local p = Instance.new("Frame")
    p.BackgroundTransparency = 0.85
    p.BorderSizePixel = 0
    p.BackgroundColor3 = Color3.fromRGB(180, 200, 255)
    p.Size = UDim2.fromOffset(math.random(2,4), math.random(2,4))
    p.Position = UDim2.new(math.random(), 0, 1.1, 0)
    p.Parent = particleFolder
    local x = math.random(-50,50)
    local dur = math.random(6,12) + math.random()
    local tw = TweenService:Create(p, TweenInfo.new(dur, Enum.EasingStyle.Linear), {
        Position = UDim2.new(p.Position.X.Scale, x, -0.1, 0),
        BackgroundTransparency = 1
    })
    tw.Completed:Connect(function() p:Destroy() end)
    tw:Play()
end

local particleConn
particleConn = RunService.Heartbeat:Connect(function(dt)
    if math.random() < 0.12 then spawnParticle() end
end)

local card = Instance.new("Frame")
card.Name = "Card"
card.AnchorPoint = Vector2.new(0.5, 0.5)
card.Position = UDim2.fromScale(0.5, 0.52)
card.Size = UDim2.new(0, 460, 0, 220)
card.BackgroundColor3 = Color3.fromRGB(20, 22, 30)
card.Parent = bg

local corner = Instance.new("UICorner", card)
corner.CornerRadius = UDim.new(0, 18)

local stroke = Instance.new("UIStroke", card)
stroke.Thickness = 1.2
stroke.Color = Color3.fromRGB(90, 110, 160)
stroke.Transparency = 0.35
stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border

local shadow = Instance.new("ImageLabel")
shadow.Name = "Shadow"
shadow.BackgroundTransparency = 1
shadow.Image = "rbxassetid://5028857084"
shadow.ImageTransparency = 0.35
shadow.ScaleType = Enum.ScaleType.Slice
shadow.SliceCenter = Rect.new(24,24,276,276)
shadow.Size = UDim2.new(1, 60, 1, 60)
shadow.Position = UDim2.fromOffset(-30, -30)
shadow.ZIndex = 0
shadow.Parent = card

local uiScale = Instance.new("UIScale", card)
local function fitScale()
    local res = workspace.CurrentCamera and workspace.CurrentCamera.ViewportSize or Vector2.new(1280,720)
    local base = math.clamp(math.min(res.X/1280, res.Y/720), 0.6, 1.2)
    uiScale.Scale = base
end
fitScale()
workspace:GetPropertyChangedSignal("CurrentCamera"):Connect(fitScale)
RunService.Heartbeat:Connect(fitScale)

local title = Instance.new("TextLabel")
title.Name = "Title"
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamSemibold
title.TextScaled = true
title.Text = "Loading"
title.TextColor3 = Color3.fromRGB(230, 236, 255)
title.Size = UDim2.new(1, -40, 0, 36)
title.Position = UDim2.fromOffset(20, 18)
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = card

local subtitle = Instance.new("TextLabel")
subtitle.Name = "Subtitle"
subtitle.BackgroundTransparency = 1
subtitle.Font = Enum.Font.Gotham
subtitle.TextScaled = true
subtitle.Text = "Preparing assets..."
subtitle.TextColor3 = Color3.fromRGB(170, 186, 220)
subtitle.Size = UDim2.new(1, -40, 0, 26)
subtitle.Position = UDim2.fromOffset(20, 58)
subtitle.TextXAlignment = Enum.TextXAlignment.Left
subtitle.Parent = card

local ring = Instance.new("ImageLabel")
ring.Name = "Ring"
ring.AnchorPoint = Vector2.new(1, 0)
ring.Position = UDim2.new(1, -20, 0, 20)
ring.Size = UDim2.fromOffset(64, 64)
ring.BackgroundTransparency = 1
ring.Image = "rbxassetid://8932511161"
ring.ImageColor3 = Color3.fromRGB(120, 160, 255)
ring.Parent = card

local t0 = tick()
RunService.Heartbeat:Connect(function()
    local r = (tick()-t0) * 80
    ring.Rotation = r % 360
end)

local bar = Instance.new("Frame")
bar.Name = "Bar"
bar.Size = UDim2.new(1, -40, 0, 12)
bar.Position = UDim2.fromOffset(20, 120)
bar.BackgroundColor3 = Color3.fromRGB(30, 34, 46)
bar.Parent = card
Instance.new("UICorner", bar).CornerRadius = UDim.new(0, 8)

local fill = Instance.new("Frame")
fill.Name = "Fill"
fill.Size = UDim2.new(0, 0, 1, 0)
fill.BackgroundColor3 = Color3.fromRGB(130, 160, 255)
fill.Parent = bar
Instance.new("UICorner", fill).CornerRadius = UDim.new(0, 8)

local fillGrad = Instance.new("UIGradient")
fillGrad.Color = ColorSequence.new(Color3.fromRGB(90,130,255), Color3.fromRGB(180,210,255))
fillGrad.Offset = Vector2.new(0,0)
fillGrad.Parent = fill

local percent = Instance.new("TextLabel")
percent.Name = "Percent"
percent.BackgroundTransparency = 1
percent.Font = Enum.Font.GothamMedium
percent.TextScaled = true
percent.Text = "0%"
percent.TextColor3 = Color3.fromRGB(210, 220, 255)
percent.Size = UDim2.new(0, 80, 0, 24)
percent.Position = UDim2.fromOffset(20, 140)
percent.TextXAlignment = Enum.TextXAlignment.Left
percent.Parent = card

local tips = {
    "Tip: You can drag most GUIs on mobile.",
    "Tip: Lower graphics for smoother performance on low-end devices.",
    "Tip: Avoid spamming teleports to reduce server kicks.",
    "Tip: Use rejoin logic to recover after disconnects.",
    "Tip: Toggle features you don't use to save FPS."
}

local tipLabel = Instance.new("TextLabel")
tipLabel.Name = "Tip"
tipLabel.BackgroundTransparency = 1
tipLabel.Font = Enum.Font.Gotham
tipLabel.TextScaled = true
tipLabel.TextWrapped = true
tipLabel.Text = tips[1]
tipLabel.TextColor3 = Color3.fromRGB(150, 170, 210)
tipLabel.Size = UDim2.new(1, -40, 0, 36)
tipLabel.Position = UDim2.fromOffset(20, 176)
tipLabel.TextXAlignment = Enum.TextXAlignment.Left
tipLabel.Parent = card

task.spawn(function()
    local i = 1
    while gui.Parent do
        task.wait(3.2)
        i = (i % #tips) + 1
        tipLabel.Text = tips[i]
        tipLabel.TextTransparency = 0.2
        TweenService:Create(tipLabel, TweenInfo.new(0.25), { TextTransparency = 0 }):Play()
    end
end)

local progress = 0
local function setProgress(p)
    p = math.clamp(p, 0, 100)
    progress = p
    percent.Text = string.format("%d%%", math.floor(p + 0.5))
    TweenService:Create(fill, TweenInfo.new(0.18, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
        { Size = UDim2.new(p/100, 0, 1, 0) }
    ):Play()
    TweenService:Create(fillGrad, TweenInfo.new(0.3), { Offset = Vector2.new(p/100 * 0.2, 0) }):Play()
end

task.spawn(function()
    local t = 0
    while gui.Parent do
        t += RunService.Heartbeat:Wait() or 0.016
        grad.Offset = Vector2.new(math.sin(t*0.12)*0.15, math.cos(t*0.08)*0.08)
    end
end)

task.spawn(function()
    -- pre-warm: get to 70%
    local target = 70
    while progress < target do
        setProgress(progress + math.random(1,3))
        task.wait(10 + math.random()*0.05)
    end

    if not game:IsLoaded() then
        subtitle.Text = "Waiting for game to finish loading..."
        game.Loaded:Wait()
    end

    subtitle.Text = "Preloading UI assets..."
    local toPreload = {}
    pcall(function()
        for _, inst in ipairs(lp.PlayerGui:GetDescendants()) do
            if inst:IsA("ImageLabel") or inst:IsA("ImageButton") then
                table.insert(toPreload, inst)
            end
        end
    end)
    pcall(function()
        ContentProvider:PreloadAsync(toPreload)
    end)

    while progress < 90 do
        setProgress(progress + 1)
        task.wait(0.035)
    end

    subtitle.Text = "Finalizing..."
    task.wait(0.4)
    setProgress(100)

    task.wait(0.1)
    local fade = Instance.new("Frame")
    fade.BackgroundColor3 = Color3.new(0,0,0)
    fade.BackgroundTransparency = 1
    fade.Size = UDim2.fromScale(1,1)
    fade.ZIndex = 10_000
    fade.Parent = gui
    TweenService:Create(fade, TweenInfo.new(0.25), { BackgroundTransparency = 0.4 }):Play()

    TweenService:Create(card, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.In),
        { Position = UDim2.fromScale(0.5, 0.46), BackgroundTransparency = 1 }):Play()
    TweenService:Create(bg, TweenInfo.new(0.25), { BackgroundTransparency = 1 }):Play()
    TweenService:Create(vignette, TweenInfo.new(0.25), { ImageTransparency = 1 }):Play()

    task.wait(0.26)
    TweenService:Create(blur, TweenInfo.new(0.25), { Size = 0 }):Play()

    task.wait(0.28)
    if particleConn then pcall(function() particleConn:Disconnect() end) end
    pcall(function() blur:Destroy() end)
    pcall(function() gui:Destroy() end)
end)
